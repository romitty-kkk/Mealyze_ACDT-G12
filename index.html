<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mealyze (EN only)</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#64748b;
      --text:#0f172a;
      --border:#e2e8f0;
      --green:#10b981;
      --green2:#059669;
      --blue:#2563eb;
      --chip:#ecfdf5;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      --shadow2: 0 10px 24px rgba(15, 23, 42, 0.08);
      --radius: 22px;
    }

    body{
      margin:0;
      padding:24px 16px 40px;
      font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-image: url(https://i.imgur.com/yAyuSTT.png);
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
      color:var(--text);
      color: #0f172a;
    }

    .app-shell{ max-width:960px; margin:0 auto; }

    /* Top nav */
    .top-nav{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 18px;
      border-radius:999px;
      background:rgba(255,255,255,0.92);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      margin-bottom:18px;
      border:1px solid rgba(226,232,240,0.8);
    }
    .nav-left{ display:flex; align-items:center; gap:10px; }
    .logo-pill{
      width:36px; height:36px; border-radius:999px;
      background:#f0be49; display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .app-meta{ display:flex; flex-direction:column; line-height:1.1; }
    .app-meta span:first-child{
      font-weight:900; font-size:30px; color:#dd5c36;
      font-family:'Playfair Display', serif;
      text-shadow:2px 2px 4px rgba(0,0,0,0.08);
    }
    .app-meta span:last-child{ font-size:12px; color:var(--muted); margin-top:2px; }
    .nav-right{ display:flex; gap:10px; align-items:center; }

    .nav-link{
      border:none; background:transparent;
      padding:8px 12px; border-radius:999px;
      cursor:pointer; color:var(--muted);
      font-weight:600;
      font-family: inherit;
      transition: background .15s ease, color .15s ease;
    }
    .nav-link:hover{ background:#e0f2fe; color:#1d4ed8; }

    /* Sections/cards */
    section.panel{
      background:rgba(255,255,255,0.92);
      border:1px solid rgba(226,232,240,0.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:20px 22px;
      margin-top:18px;
    }

    h1{ margin:0; font-size:24px; }
    h2{ margin:0 0 8px; font-size:20px; }
    h3{ margin:16px 0 8px; font-size:16px; }

    .step-label{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      background: var(--chip);
      color:#047857; font-weight:800; font-size:12px;
      border:1px solid rgba(4,120,87,0.20);
      margin-bottom:10px;
    }
    .step-label .circle{
      width:18px; height:18px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background:#22c55e; color:#ecfdf5; font-size:11px; font-weight:900;
    }

    label{ display:block; margin-top:10px; font-weight:700; font-size:14px; }
    input[type="file"], input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea{
      width:100%; box-sizing:border-box;
      margin-top:6px; padding:10px 14px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
      font-size:14px;
    }
    textarea{ border-radius:16px; min-height:70px; resize:vertical; }

    input:focus, select:focus, textarea:focus{
      border-color:#4f46e5;
      box-shadow:0 0 0 3px rgba(79,70,229,0.15);
      background:#fff;
    }

    button{
      margin-top:10px;
      padding:10px 18px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-weight:800;
      font-family: inherit;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
    }
    button:active{ transform: translateY(1px); }

    .primary-btn{
      background: var(--green);
      border-color:#0f766e;
      color:#fff;
      box-shadow:0 14px 30px rgba(16,185,129,0.30);
    }
    .primary-btn:hover{ background:var(--green2); }

    .secondary-btn{
      background: rgba(255,255,255,0.9);
      border:1px dashed #c4b5fd;
      color:#4f46e5;
    }
    .secondary-btn:hover{ background:#eef2ff; }

    .ghost-btn{ background: rgba(255,255,255,0.75); }
    .ghost-btn:hover{ background:#e5e7eb; }

    .nav-buttons{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }

    #image-preview{
      max-width:100%;
      margin-top:8px;
      border-radius:16px;
      border:1px solid var(--border);
      display:none;
    }

    /* ===== Result UI (like image #2) ===== */
    .result-wrap{
      margin-top:12px;
      border-radius: 26px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow2);
      padding:16px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      font-weight:900;
      margin-bottom:10px;
    }

    .score-bar{
      margin:10px 0 14px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(16,185,129,0.10);
      border:1px solid rgba(16,185,129,0.25);
      color:#065f46;
      font-weight:800;
    }

    .card{
      border-radius: 18px;
      border:1px solid var(--border);
      background:#f8fafc;
      padding:14px 14px;
      margin-top:12px;
    }
    .card .title{
      font-size:12px;
      letter-spacing:0.08em;
      color:var(--muted);
      font-weight:900;
      margin-bottom:8px;
      text-transform:uppercase;
    }
    .card .body{
      font-size:14px;
      line-height:1.55;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .show-more{
      margin-top:10px;
      display:inline-block;
      color: var(--blue);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }

    .list{
      margin:0; padding-left: 18px;
      font-size:14px;
      line-height:1.55;
    }

    .nutrition-line{
      font-size:14px; color:#334155;
    }

    /* ===== Energy legend & detail (your previous style) ===== */
    .energy-legend{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
      color:#334155;
    }
    .energy-legend .item{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      max-width: 100%;
      cursor:pointer;
      user-select:none;
    }
    .energy-legend .item:hover{
      background:#e0f2fe;
      border-color:#93c5fd;
    }
    .energy-legend .emoji{ font-size:16px; line-height:1; }
    .energy-legend .time{ font-weight:900; color:#0f172a; }
    .energy-legend .text{
      color:#475569;
      max-width:260px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    #energy-event-detail{
      display:none;
      margin-top:10px;
      border-radius:16px;
      border:1px solid #e2e8f0;
      background: rgba(255,255,255,0.9);
      padding:10px 12px;
      font-size:13px;
      color:#0f172a;
    }
    #energy-event-detail .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #energy-event-detail .pill2{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#ecfdf5;
      color:#047857;
      border:1px solid rgba(4,120,87,0.25);
      font-weight:900;
      font-size:12px;
    }
    #energy-event-detail .muted{ color:#64748b; font-size:12px; }
    #energy-event-detail .desc{ margin-top:6px; color:#334155; line-height:1.35; }
    #energy-event-detail button{
      margin-top:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#fff;
      font-size:12px;
      cursor:pointer;
    }
    #energy-event-detail button:hover{ background:#f1f5f9; }

    pre{
      background:#0f172a;
      color:#e5e7eb;
      border-radius:16px;
      padding:10px 12px;
      font-size:13px;
      overflow-x:auto;
      white-space: pre-wrap;
    }

    @media (max-width: 640px){
      body{ padding:16px 10px 32px; }
      .top-nav{ flex-direction:column; align-items:flex-start; gap:8px; border-radius:20px; }
      .nav-right{ width:100%; flex-wrap:wrap; justify-content:flex-start; }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="top-nav">
      <div class="nav-left">
        <div class="logo-pill">ü•ó</div>
        <div class="app-meta">
          <span>Mealyze</span>
          <span>Meal+Analyze = Get personalized food guidance for a healthier life!</span>
        </div>
      </div>
      <div class="nav-right">
        <button class="nav-link" id="nav-today">Today‚Äôs meal</button>
        <button class="nav-link" id="nav-history">History</button>
        <button class="nav-link" id="nav-insights">Insights</button>
      </div>
    </header>

    <!-- A. Home -->
    <section class="panel" id="section-mode-select">
      <div class="step-label"><span class="circle">üè†</span><span>Home</span></div>
      <h2 style="font-family: inherit; font-size:26px; margin-bottom:6px;">Turn your meal photo into a gentle health check.</h2>
      <p style="color:var(--muted); margin:0; max-width:520px;">
        Upload your food, tell us how you‚Äôre doing today, and we‚Äôll give simple advice that matches your goal.
      </p>
      <div class="nav-buttons">
        <button id="btn-go-photo-hero" class="primary-btn">Start with a food photo üì∏</button>
        <button id="btn-go-simple" class="secondary-btn">Simple menu only</button>
        <button id="btn-go-profile" class="ghost-btn">Log in with profile (BMI)</button>
      </div>
    </section>

    <!-- B. Simple -->
    <section class="panel" id="section-simple" style="display:none;">
      <div class="step-label"><span class="circle">A</span><span>Text-only quick suggestion</span></div>
      <h2>Simple Menu Recommendation</h2>
      <p style="color:var(--muted); margin:0;">Just tell us foods you like and dislike. (No login, no photo)</p>

      <label for="like-input">Foods you like</label>
      <input type="text" id="like-input" placeholder="e.g., cold noodles, spicy food" />

      <label for="dislike-input">Foods you dislike / allergy</label>
      <input type="text" id="dislike-input" placeholder="e.g., seafood, peanuts" />

      <button id="btn-simple-recommend" class="primary-btn">Get simple menu</button>
      <div class="card" style="margin-top:12px;">
        <div class="title">RESULT</div>
        <div class="body" id="simple-recommend-result">(No result yet)</div>
      </div>

      <div class="nav-buttons">
        <button id="btn-simple-back" class="ghost-btn">Back to home</button>
      </div>
    </section>

    <!-- C. Profile -->
    <section class="panel" id="section-profile" style="display:none;">
      <div class="step-label"><span class="circle">0</span><span>Set up your profile</span></div>
      <h2>User Profile (Login)</h2>
      <p style="color:var(--muted); margin:0;">We‚Äôll use your BMI only for gentle context and long-term patterns.</p>

      <label for="name-input">Name</label>
      <input type="text" id="name-input" placeholder="e.g., Seoyeon Park" />

      <label for="height-input">Height (cm)</label>
      <input type="number" id="height-input" placeholder="e.g., 165" />

      <label for="weight-input">Weight (kg)</label>
      <input type="number" id="weight-input" placeholder="e.g., 60" />

      <button id="btn-save-profile" class="primary-btn">Save Profile</button>
      <div class="card">
        <div class="title">BMI</div>
        <div class="body" id="bmi-info">(No profile yet)</div>
      </div>

      <div class="nav-buttons">
        <button id="btn-profile-next" class="secondary-btn">Go to Profile Menu</button>
        <button id="btn-profile-back-home" class="ghost-btn">Back to home</button>
      </div>
    </section>

    <!-- D. Profile Menu -->
    <section class="panel" id="section-profile-menu" style="display:none;">
      <div class="step-label"><span class="circle">0</span><span>Your profile</span></div>
      <h2>Profile Menu</h2>
      <div class="card">
        <div class="title">BMI</div>
        <div class="body" id="bmi-info-menu">(No profile yet)</div>
      </div>

      <div class="nav-buttons">
        <button id="btn-go-photo" class="primary-btn">Analyze a food photo</button>
        <button id="btn-go-history" class="secondary-btn">View history & insights</button>
        <button id="btn-profile-menu-back" class="ghost-btn">Back to profile</button>
        <button id="btn-profile-menu-home" class="ghost-btn">Back to home</button>
      </div>
    </section>

    <!-- E. Photo -->
    <section class="panel" id="section-photo" style="display:none;">
      <div class="step-label"><span class="circle">1</span><span>Upload & context</span></div>
      <h2>Food Photo Analysis</h2>
      <p style="color:var(--muted); margin:0;">Upload a meal photo and get a readable, structured result + energy curve.</p>

      <h3>Step 1 ¬∑ Upload</h3>
      <label for="image-input">Food Image</label>
      <input type="file" id="image-input" accept="image/*" />
      <img id="image-preview" alt="preview"/>

      <label for="goal-select">Goal</label>
      <select id="goal-select">
        <option value="cut">cut (lose body fat)</option>
        <option value="bulk">bulk (gain muscle)</option>
        <option value="maintain">maintain (keep weight)</option>
      </select>

      <label for="meal-date">Meal Date</label>
      <input type="date" id="meal-date" />

      <label for="meal-time">Meal Time</label>
      <input type="time" id="meal-time" />
      <div style="margin-top:6px; font-size:13px; color:var(--muted); font-style:italic;" id="meal-type-display">Meal type: (auto)</div>

      <label for="status-input">Short status / note (optional)</label>
      <input type="text" id="status-input" placeholder="e.g., Late-night snack, I didn't eat lunch" />

      <button id="btn-recommend" class="primary-btn">Get Recommendation</button>

      <h3 style="margin-top:20px;">Step 2 ¬∑ Recognition & advice</h3>

      <div class="result-wrap" id="result-wrap" style="display:none;">
        <div class="pill" id="recognized-pill">Recognized Food: (none)</div>

        <div class="score-bar" id="goal-score-bar">
          Goal Score: <span id="goal-score">-</span>
        </div>

        <div class="card">
          <div class="title">YOUR MEAL EVALUATOR</div>
          <div class="body" id="meal-eval-text">(No evaluation yet)</div>
          <div class="show-more" id="meal-eval-more" style="display:none;">Show more</div>
        </div>

        <div class="card">
          <div class="title">RECOMMENDED DISHES</div>
          <div class="body">
            <ul class="list" id="recommend-list"></ul>
          </div>
        </div>

        <div class="card">
          <div class="title">WHY THESE DISHES?</div>
          <div class="body" id="recommend-reason-text">(No reason yet)</div>
          <div class="show-more" id="reason-more" style="display:none;">Show more</div>
        </div>

        <div class="card">
          <div class="title">SUMMARY</div>
          <div class="body" id="summary-text">(No summary yet)</div>
          <div class="show-more" id="summary-more" style="display:none;">Show more</div>
        </div>

        <div class="card">
          <div class="title">NUTRITION</div>
          <div class="body nutrition-line" id="nutrition-info">No nutrition data in table.</div>
        </div>

        <div class="card">
          <div class="title">ENERGY CURVE PREVIEW (NEXT 4 HOURS)</div>

          <div id="energy-wrap" style="display:none; margin-top:8px;">
            <div id="energy-microcopy" style="font-size:13px; color:var(--muted); margin-bottom:6px;"></div>

            <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">
              Solid line = Energy ¬∑ Dashed line = Glucose (approx.)
            </div>

            <div id="energy-chart"></div>
            <div id="energy-legend" class="energy-legend"></div>

            <div id="energy-event-detail">
              <div class="row">
                <span class="pill2" id="energy-event-pill">üçΩÔ∏è Event</span>
                <span class="muted" id="energy-event-time">Time</span>
              </div>
              <div class="desc" id="energy-event-text">Details</div>
              <button id="energy-event-close" type="button">Close</button>
            </div>
          </div>

          <div id="energy-empty" style="font-size:13px; color:var(--muted); display:block;">
            (No curve yet)
          </div>
        </div>
      </div>

      <h3 style="margin-top:18px;">Step 3 ¬∑ Manual override</h3>
      <p style="color:var(--muted); margin:0;">
        If the predicted dish is wrong, type the correct food name and re-run.
      </p>
      <label for="manual-food">Type the correct food name</label>
      <input type="text" id="manual-food" placeholder="e.g., Kimchi Stew, Fried Egg, Bibimbap" />
      <button id="btn-override" class="secondary-btn">Override & Re-run</button>

      <div class="nav-buttons">
        <button id="btn-photo-back" class="ghost-btn">Back to Profile Menu</button>
        <button id="btn-photo-home" class="ghost-btn">Back to home</button>
      </div>
    </section>

    <!-- F. History -->
    <section class="panel" id="section-history" style="display:none;">
      <div class="step-label"><span class="circle">H</span><span>History & trends</span></div>
      <h2>History & Analysis</h2>

      <h3>Recent calls</h3>
      <button id="btn-history-refresh" class="secondary-btn">Refresh History</button>
      <div id="history-container" style="margin-top:10px;"></div>

      <h3 style="margin-top:18px;">History Analysis</h3>
      <button id="btn-analyze-7d" class="primary-btn">Analyze last 7 days</button>
      <button id="btn-analyze-30d" class="secondary-btn">Analyze last 30 days</button>

      <div style="margin-top: 10px;">
        <label>Custom range</label>
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;">
          <input type="date" id="start-date" style="flex:1 1 140px;" />
          <input type="date" id="end-date" style="flex:1 1 140px;" />
          <button id="btn-analyze-range" class="ghost-btn">Analyze this range</button>
        </div>
      </div>

      <pre id="analysis-result" style="margin-top: 10px;"></pre>

      <h3>AI Analysis & One-day Meal Plan</h3>
      <pre id="analysis-ai-result" style="margin-top: 10px;"></pre>

      <div class="nav-buttons">
        <button id="btn-history-back" class="ghost-btn">Back to Profile Menu</button>
        <button id="btn-history-home" class="ghost-btn">Back to home</button>
      </div>
    </section>
  </div>

  <script>
    // ====== CONFIG ======
    const API_URL = "https://phytogenic-glinda-unlogical.ngrok-free.dev";
    const DEMO_URL = "https://youtu.be/rxnG7ObackQ";
    const NGROK_HEADERS = { "ngrok-skip-browser-warning": "69420" };
    const FORCE_GLUCOSE_LINE = true;

    // ====== NAV / Sections ======
    const sectionModeSelect  = document.getElementById("section-mode-select");
    const sectionSimple      = document.getElementById("section-simple");
    const sectionProfile     = document.getElementById("section-profile");
    const sectionProfileMenu = document.getElementById("section-profile-menu");
    const sectionPhoto       = document.getElementById("section-photo");
    const sectionHistory     = document.getElementById("section-history");

    function showSection(which){
      [sectionModeSelect, sectionSimple, sectionProfile, sectionProfileMenu, sectionPhoto, sectionHistory]
        .forEach(s => s.style.display = "none");
      if(which==="mode") sectionModeSelect.style.display="block";
      if(which==="simple") sectionSimple.style.display="block";
      if(which==="profile") sectionProfile.style.display="block";
      if(which==="profileMenu") sectionProfileMenu.style.display="block";
      if(which==="photo") sectionPhoto.style.display="block";
      if(which==="history") sectionHistory.style.display="block";
    }
    showSection("mode");

    // ====== State ======
    let profile = { name:"", height_cm:null, weight_kg:null, bmi:null, bmi_label:"" };
    let cachedHistory = [];
    let lastMealDatetimeISO = "";

    // ====== DOM refs ======
    const nameInput = document.getElementById("name-input");
    const heightInput = document.getElementById("height-input");
    const weightInput = document.getElementById("weight-input");
    const btnSaveProfile = document.getElementById("btn-save-profile");
    const bmiInfoDiv = document.getElementById("bmi-info");
    const bmiInfoMenuDiv = document.getElementById("bmi-info-menu");

    const imageInput = document.getElementById("image-input");
    const imagePreview = document.getElementById("image-preview");

    const goalSelect = document.getElementById("goal-select");
    const statusInput = document.getElementById("status-input");
    const manualFoodInput = document.getElementById("manual-food");

    const mealDateInput = document.getElementById("meal-date");
    const mealTimeInput = document.getElementById("meal-time");
    const mealTypeDisplay = document.getElementById("meal-type-display");

    const btnRecommend = document.getElementById("btn-recommend");
    const btnOverride = document.getElementById("btn-override");

    const likeInput = document.getElementById("like-input");
    const dislikeInput = document.getElementById("dislike-input");
    const btnSimpleRecommend = document.getElementById("btn-simple-recommend");
    const simpleRecommendResult = document.getElementById("simple-recommend-result");

    const btnHistoryRefresh = document.getElementById("btn-history-refresh");
    const historyContainer = document.getElementById("history-container");
    const analysisResult = document.getElementById("analysis-result");
    const analysisAiResult = document.getElementById("analysis-ai-result");
    const btnAnalyze7d = document.getElementById("btn-analyze-7d");
    const btnAnalyze30d = document.getElementById("btn-analyze-30d");
    const btnAnalyzeRange = document.getElementById("btn-analyze-range");
    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");

    // ====== Result UI refs (readable cards) ======
    const resultWrap = document.getElementById("result-wrap");
    const recognizedPill = document.getElementById("recognized-pill");
    const goalScoreSpan = document.getElementById("goal-score");
    const goalScoreBar = document.getElementById("goal-score-bar");

    const mealEvalText = document.getElementById("meal-eval-text");
    const mealEvalMore = document.getElementById("meal-eval-more");

    const recommendListUL = document.getElementById("recommend-list");

    const recommendReasonText = document.getElementById("recommend-reason-text");
    const reasonMore = document.getElementById("reason-more");

    const summaryText = document.getElementById("summary-text");
    const summaryMore = document.getElementById("summary-more");

    const nutritionDiv = document.getElementById("nutrition-info");

    // Energy refs
    const eventDetailWrap = document.getElementById("energy-event-detail");
    const eventDetailPill = document.getElementById("energy-event-pill");
    const eventDetailTime = document.getElementById("energy-event-time");
    const eventDetailText = document.getElementById("energy-event-text");
    const eventDetailClose = document.getElementById("energy-event-close");
    const energyEmpty = document.getElementById("energy-empty");

    if(eventDetailClose){
      eventDetailClose.addEventListener("click", () => { eventDetailWrap.style.display="none"; });
    }

    // ===== Utils =====
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ‚úÖ UPDATED: graceful offline notice (no alert) ‚Äî TEXT ONLY CHANGED
    function showDemoCheckNotice(where){
      const msg =
        "This feature depends on an on-demand GPU runtime, which is not active at the moment.\n" +
        "Please watch the demo video: " + DEMO_URL;

      const whereTag = where ? `(${where})` : "";

      // 1) Photo result area (so user/judge sees a clear message)
      try{
        if(resultWrap){
          resultWrap.style.display = "block";
          recognizedPill.textContent = `Recognized Food: (GPU runtime inactive) ${whereTag}`.trim();
          goalScoreSpan.textContent = "-";

          if(mealEvalMore) mealEvalMore.style.display = "none";
          if(reasonMore) reasonMore.style.display = "none";
          if(summaryMore) summaryMore.style.display = "none";

          if(mealEvalText) mealEvalText.textContent = msg;
          if(recommendReasonText) recommendReasonText.textContent = msg;
          if(summaryText) summaryText.textContent = msg;
          if(nutritionDiv) nutritionDiv.textContent = msg;

          if(recommendListUL){
            recommendListUL.innerHTML = "";
            const li = document.createElement("li");
            li.textContent = msg;
            recommendListUL.appendChild(li);
          }

          // hide energy detail + show empty state
          if(eventDetailWrap) eventDetailWrap.style.display = "none";
          if(typeof renderEnergyPreview === "function") renderEnergyPreview(null);
        }
      }catch(e){ console.log("notice(photo) error", e); }

      // 2) Simple menu area
      try{
        if(simpleRecommendResult){
          simpleRecommendResult.textContent = msg;
        }
      }catch(e){ console.log("notice(simple) error", e); }

      // 3) History area
      try{
        if(historyContainer && (where === "History" || where === "Insights" || where === "History load")){
          historyContainer.innerHTML = `
            <div class="card">
              <div class="title">GPU RUNTIME INACTIVE</div>
              <div class="body">${escapeHtml(msg)}</div>
            </div>
          `;
        }
      }catch(e){ console.log("notice(history) error", e); }

      // 4) AI analysis pre area
      try{
        if(analysisAiResult && (where === "Insights" || where === "AI analysis")){
          analysisAiResult.textContent = msg;
        }
      }catch(e){ console.log("notice(ai) error", e); }

      // also log for debugging (keeps original features)
      console.log("GPU runtime inactive notice shown:", where || "(unknown)");
    }

    function updateBmiInfo(){
      if(!profile.height_cm || !profile.weight_kg || !profile.bmi){
        bmiInfoDiv.textContent="(No profile yet)";
        bmiInfoMenuDiv.textContent="(No profile yet)";
        return;
      }
      const text = `Name: ${profile.name || "-"}, Height: ${profile.height_cm} cm, Weight: ${profile.weight_kg} kg, BMI: ${profile.bmi.toFixed(1)} (${profile.bmi_label})`;
      bmiInfoDiv.textContent=text;
      bmiInfoMenuDiv.textContent=text;
    }

    btnSaveProfile.addEventListener("click", ()=>{
      const n = nameInput.value.trim();
      const h = parseFloat(heightInput.value);
      const w = parseFloat(weightInput.value);
      if(!h || !w){ alert("Please fill in both height and weight."); return; }
      const bmi = w / ((h/100)*(h/100));
      let label="";
      if(bmi < 18.5) label="underweight";
      else if(bmi < 23) label="normal";
      else if(bmi < 25) label="overweight (Asian cutoff)";
      else label="obese (Asian cutoff)";

      profile = { name:n, height_cm:h, weight_kg:w, bmi:bmi, bmi_label:label };
      localStorage.setItem("meal_profile", JSON.stringify(profile));
      updateBmiInfo();
    });

    const savedProfile = localStorage.getItem("meal_profile");
    if(savedProfile){
      try{
        const parsed = JSON.parse(savedProfile);
        profile = parsed || profile;
        if(profile.name) nameInput.value = profile.name;
        if(profile.height_cm) heightInput.value = profile.height_cm;
        if(profile.weight_kg) weightInput.value = profile.weight_kg;
        updateBmiInfo();
      }catch(e){ console.log("profile load error", e); }
    }

    // Meal type
    function computeMealType(){
      const t = mealTimeInput.value;
      if(!t){ mealTypeDisplay.textContent="Meal type: (unknown)"; return ""; }
      const h = parseInt(t.split(":")[0],10);
      let type="snack";
      if(h >= 5 && h < 11) type="breakfast";
      else if(h >= 11 && h < 15) type="lunch";
      else if(h >= 15 && h < 18) type="snack";
      else if(h >= 18 && h < 22) type="dinner";
      else type="late_night";
      mealTypeDisplay.textContent="Meal type: " + type;
      return type;
    }
    mealTimeInput.addEventListener("change", computeMealType);

    // Image preview
    imageInput.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if(!file){ imagePreview.style.display="none"; imagePreview.src=""; return; }
      imagePreview.src = URL.createObjectURL(file);
      imagePreview.style.display="block";
    });

    // ===== Collapsible helper (for ‚ÄúShow more‚Äù) =====
    function setCollapsible(elBody, elBtn, fullText, maxChars=170){
      const text = (fullText || "").trim();
      if(!text){
        elBody.textContent = "(No data)";
        elBtn.style.display="none";
        return;
      }

      if(text.length <= maxChars){
        elBody.textContent = text;
        elBtn.style.display="none";
        return;
      }

      let expanded = false;
      const short = text.slice(0, maxChars).trim() + "‚Ä¶";

      elBody.textContent = short;
      elBtn.style.display = "inline-block";
      elBtn.textContent = "Show more";

      elBtn.onclick = ()=>{
        expanded = !expanded;
        elBody.textContent = expanded ? text : short;
        elBtn.textContent = expanded ? "Show less" : "Show more";
      };
    }

    // ===== Energy Curve (SVG) =====
    function showEnergyEventDetail(ev, labelForT){
      if(!eventDetailWrap || !eventDetailPill || !eventDetailTime || !eventDetailText) return;
      const emoji = ev.emoji || "‚Ä¢";
      const t = Number(ev.t ?? 0);
      const timeLbl = labelForT ? labelForT(t) : "";
      const text = ev.text || "";
      eventDetailPill.textContent = `${emoji} Event`;
      eventDetailTime.textContent = timeLbl ? `at ${timeLbl}` : "";
      eventDetailText.textContent = text;
      eventDetailWrap.style.display="block";
      eventDetailWrap.scrollIntoView({behavior:"smooth", block:"nearest"});
    }

    function renderEnergyPreview(data){
      const wrap = document.getElementById("energy-wrap");
      const chart = document.getElementById("energy-chart");
      const micro = document.getElementById("energy-microcopy");
      const legend = document.getElementById("energy-legend");

      if(!wrap || !chart || !micro || !legend) return;

      if(!data || !data.curve || !Array.isArray(data.curve.points) || data.curve.points.length === 0){
        wrap.style.display="none";
        chart.innerHTML="";
        micro.textContent="";
        legend.innerHTML="";
        if(eventDetailWrap) eventDetailWrap.style.display="none";
        if(energyEmpty) energyEmpty.style.display="block";
        return;
      }

      if(energyEmpty) energyEmpty.style.display="none";
      wrap.style.display="block";

      micro.textContent = data.microcopy || "Expected curve (next 4 hours). Click emojis for details.";

      const points = data.curve.points;
      const events = Array.isArray(data.events) ? data.events : [];

      const W=720, H=200, PAD=18;
      const horizon = Number(data.curve.horizon_min || 240);
      const yMin = (data.curve.y_min ?? 0);
      const yMax = (data.curve.y_max ?? 100);

      const x = (t)=> PAD + (t/horizon)*(W-PAD*2);
      const y = (val)=> PAD + (1 - (val - yMin)/(yMax-yMin))*(H-PAD*2);

      const baseISO = (data.curve && data.curve.start_iso) ? data.curve.start_iso : lastMealDatetimeISO;
      const baseDate = baseISO ? new Date(baseISO) : null;
      const hasBase = baseDate && !Number.isNaN(baseDate.getTime());

      function formatOffsetMin(t){
        const m = Math.max(0, Math.round(t));
        if(m===0) return "now";
        const hh = Math.floor(m/60);
        const mm = m%60;
        if(hh>0 && mm>0) return `+${hh}h ${mm}m`;
        if(hh>0) return `+${hh}h`;
        return `+${mm}m`;
      }
      function formatClock(base, t){
        const d = new Date(base.getTime() + Math.round(t)*60000);
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }
      function labelForT(t){ return hasBase ? formatClock(baseDate, t) : formatOffsetMin(t); }

      function nearestY(t){
        let best=points[0], bestD=Math.abs(points[0].t - t);
        for(const p of points){
          const d=Math.abs(p.t - t);
          if(d < bestD){ bestD=d; best=p; }
        }
        return best.y;
      }

      const pathD = points.map((p,i)=>{
        const cmd = i===0 ? "M" : "L";
        return `${cmd}${x(p.t).toFixed(1)} ${y(p.y).toFixed(1)}`;
      }).join(" ");

      let glucosePoints=[];
      if(data.glucose_curve && Array.isArray(data.glucose_curve.points) && data.glucose_curve.points.length){
        glucosePoints = data.glucose_curve.points;
      }else if(FORCE_GLUCOSE_LINE){
        glucosePoints = points.map((p)=>{
          const g = 0.88*p.y + 6;
          return { t:p.t, y: Math.max(0, Math.min(100, g)) };
        });
      }

      const glucoseD = (glucosePoints && glucosePoints.length)
        ? glucosePoints.map((p,i)=>{
            const cmd = i===0 ? "M" : "L";
            return `${cmd}${x(p.t).toFixed(1)} ${y(p.y).toFixed(1)}`;
          }).join(" ")
        : "";

      const gridYVals=[20,40,60,80];
      const gridY = gridYVals.map(v=>{
        const yy=y(v).toFixed(1);
        return `<line x1="${PAD}" y1="${yy}" x2="${W-PAD}" y2="${yy}" stroke="rgba(15,23,42,0.08)" />`;
      }).join("");

      const axisY = H - PAD;
      const xAxis = `<line x1="${PAD}" y1="${axisY}" x2="${W-PAD}" y2="${axisY}" stroke="rgba(15,23,42,0.18)" />`;

      const tickEvery=30;
      const ticks=[];
      for(let t=0; t<=horizon; t+=tickEvery) ticks.push(t);
      if(ticks[ticks.length-1] !== horizon) ticks.push(horizon);

      const xTicks = ticks.map(t=>{
        const xx=x(t).toFixed(1);
        const lbl=escapeHtml(labelForT(t));
        return `
          <line x1="${xx}" y1="${axisY}" x2="${xx}" y2="${(axisY+6).toFixed(1)}" stroke="rgba(15,23,42,0.18)" />
          <text x="${xx}" y="${(axisY+18).toFixed(1)}" text-anchor="middle" font-size="11" fill="rgba(15,23,42,0.75)">${lbl}</text>
        `;
      }).join("");

      const eventMarks = events.map((ev,idx)=>{
        const t=Number(ev.t ?? 0);
        if(!Number.isFinite(t)) return "";
        const ex=x(t).toFixed(1);
        const ey=y(nearestY(t)).toFixed(1);
        const emoji=escapeHtml(ev.emoji || "‚Ä¢");
        const text=escapeHtml(ev.text || "");
        const timeLbl=escapeHtml(labelForT(t));
        return `
          <line x1="${ex}" y1="${PAD}" x2="${ex}" y2="${axisY}" stroke="rgba(15,23,42,0.12)" stroke-dasharray="4 4" />
          <text class="ev-emoji" data-idx="${idx}" x="${ex}" y="${(parseFloat(ey)-10).toFixed(1)}" text-anchor="middle" font-size="16" style="cursor:pointer;">
            ${emoji}
            <title>${timeLbl} ¬∑ ${text}</title>
          </text>
          <circle class="ev-dot" data-idx="${idx}" cx="${ex}" cy="${ey}" r="3" fill="rgba(15,23,42,0.35)" style="cursor:pointer;">
            <title>${timeLbl} ¬∑ ${text}</title>
          </circle>
        `;
      }).join("");

      chart.innerHTML = `
        <svg viewBox="0 0 ${W} ${H}" style="width:100%; height:200px; display:block; background:rgba(255,255,255,0.85); border:1px solid #e2e8f0; border-radius:16px;">
          ${gridY}
          <path d="${pathD}" fill="none" stroke="rgba(15,23,42,0.85)" stroke-width="2.5" />
          ${glucoseD ? `<path d="${glucoseD}" fill="none" stroke="rgba(15,23,42,0.55)" stroke-width="2" stroke-dasharray="6 6" />` : ""}
          ${eventMarks}
          ${xAxis}
          ${xTicks}
          <text x="${PAD}" y="${(PAD+10)}" font-size="11" fill="rgba(15,23,42,0.55)">Score (0‚Äì100)</text>
          <text x="${W-PAD}" y="${(H-4)}" text-anchor="end" font-size="11" fill="rgba(15,23,42,0.55)">Time</text>
        </svg>
      `;

      const svg = chart.querySelector("svg");
      if(svg && events.length){
        const handler = (e)=>{
          const idx = e.target?.getAttribute?.("data-idx");
          if(idx == null) return;
          const ev = events[Number(idx)];
          if(!ev) return;
          showEnergyEventDetail(ev, labelForT);
        };
        svg.querySelectorAll(".ev-emoji").forEach(el => el.addEventListener("click", handler));
        svg.querySelectorAll(".ev-dot").forEach(el => el.addEventListener("click", handler));
      }

      if(!events.length){
        legend.innerHTML = `<div style="font-size:12px; color:#64748b; margin-top:6px;">No event tags for this meal.</div>`;
        if(eventDetailWrap) eventDetailWrap.style.display="none";
        return;
      }

      legend.innerHTML = events.map((ev,idx)=>{
        const t=Number(ev.t ?? 0);
        const emoji=escapeHtml(ev.emoji || "‚Ä¢");
        const text=escapeHtml(ev.text || "");
        const timeLbl=escapeHtml(labelForT(t));
        return `
          <div class="item" data-idx="${idx}" title="${timeLbl} ¬∑ ${text}">
            <span class="emoji">${emoji}</span>
            <span class="time">${timeLbl}</span>
            <span class="text">${text}</span>
          </div>
        `;
      }).join("");

      legend.querySelectorAll(".item").forEach(el=>{
        el.addEventListener("click", ()=>{
          const idx=Number(el.getAttribute("data-idx"));
          const ev=events[idx];
          if(!ev) return;
          showEnergyEventDetail(ev, labelForT);
        });
      });
    }

    function updateUIWithRecommend(data){
      resultWrap.style.display = "block";

      const conf = typeof data.food_conf === "number" ? (data.food_conf*100).toFixed(1) : "0.0";
      recognizedPill.textContent =
        `Recognized Food: ${data.food || "(unknown)"} (${conf}%)` + (data.manual_override ? " ¬∑ manual" : "");

      if(data.goal_score_text){
        goalScoreSpan.textContent = data.goal_score_text;
      }else if(typeof data.goal_score === "number"){
        goalScoreSpan.textContent = `${data.goal_score}/10`;
      }else{
        goalScoreSpan.textContent = "-";
      }

      setCollapsible(mealEvalText, mealEvalMore, (data.meal_eval || data.en || ""), 200);
      setCollapsible(recommendReasonText, reasonMore, (data.recommend_reason || ""), 220);
      setCollapsible(summaryText, summaryMore, (data.summary || ""), 180);

      recommendListUL.innerHTML = "";
      const recRaw = (data.recommend || "").trim();
      let items = [];
      if(recRaw){
        if(recRaw.includes("\n")){
          items = recRaw.split("\n").map(s=>s.replace(/^\s*[-‚Ä¢]\s*/,"").trim()).filter(Boolean);
        }else if(recRaw.includes(" - ")){
          items = recRaw.split(" - ").map(s=>s.trim()).filter(Boolean);
        }else if(recRaw.includes(",")){
          items = recRaw.split(",").map(s=>s.trim()).filter(Boolean);
        }else{
          items = [recRaw];
        }
      }

      if(!items.length){
        const li = document.createElement("li");
        li.textContent = "(No recommendation yet)";
        recommendListUL.appendChild(li);
      }else{
        items.forEach(txt=>{
          const li = document.createElement("li");
          li.textContent = txt;
          recommendListUL.appendChild(li);
        });
      }

      if(data.nutrition && data.nutrition.food_name){
        const n = data.nutrition;
        nutritionDiv.textContent =
          `${n.food_name}: ${n.kcal} kcal, ${n.protein_g}g P / ${n.fat_g}g F / ${n.carbs_g}g C | tags: ${data.tags || ""}`;
      }else{
        nutritionDiv.textContent = "No nutrition data in table.";
      }

      if(eventDetailWrap) eventDetailWrap.style.display = "none";
      renderEnergyPreview(data);
    }

    // ===== Simple menu =====
    btnSimpleRecommend.addEventListener("click", ()=>{
      const likeText = likeInput.value.trim();
      const dislikeText = dislikeInput.value.trim();
      if(!likeText && !dislikeText){ alert("Please type at least one thing you like or dislike."); return; }

      const payload = { like: likeText, dislike: dislikeText, goal: goalSelect.value, bmi: profile.bmi, bmi_label: profile.bmi_label };
      simpleRecommendResult.textContent = "Loading simple recommendation...";

      fetch(API_URL + "/api/simple_recommend", {
        method:"POST",
        headers:{ ...NGROK_HEADERS, "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      })
      .then(res=>res.json())
      .then(data=>{
        simpleRecommendResult.textContent = data.result || data.text || data.recommend || JSON.stringify(data);
      })
      .catch(err=>{
        console.log("simple recommend error:", err);
        showDemoCheckNotice("Simple menu");
      });
    });

    // ===== Recommend (photo) =====
    btnRecommend.addEventListener("click", ()=>{
      if(!imageInput.files || imageInput.files.length===0){
        alert("Please upload a food photo first.");
        return;
      }

      const formData = new FormData();
      formData.append("image", imageInput.files[0]);
      formData.append("goal", goalSelect.value);
      formData.append("user_text", statusInput.value);
      formData.append("manual_food", "");

      const mealType = computeMealType();
      const dateStr = mealDateInput.value;
      const timeStr = mealTimeInput.value;
      const mealDatetime = (dateStr && timeStr) ? `${dateStr}T${timeStr}` : "";
      lastMealDatetimeISO = mealDatetime;

      formData.append("height_cm", profile.height_cm || "");
      formData.append("weight_kg", profile.weight_kg || "");
      formData.append("meal_type", mealType || "");
      formData.append("meal_datetime", mealDatetime);

      fetch(API_URL + "/api/recommend", { method:"POST", body: formData, headers: NGROK_HEADERS })
        .then(res=>res.json())
        .then(data=>updateUIWithRecommend(data))
        .catch(err=>{
          console.log("recommend error:", err);
          showDemoCheckNotice("Recommendation");
        });
    });

    // ===== Override =====
    btnOverride.addEventListener("click", ()=>{
      const manualFood = manualFoodInput.value.trim();
      if(!manualFood){ alert("Please type a food name first."); return; }
      if(!imageInput.files || imageInput.files.length===0){ alert("Please upload a food photo first."); return; }

      const formData = new FormData();
      formData.append("image", imageInput.files[0]);
      formData.append("goal", goalSelect.value);
      formData.append("user_text", statusInput.value);
      formData.append("manual_food", manualFood);

      const mealType = computeMealType();
      const dateStr = mealDateInput.value;
      const timeStr = mealTimeInput.value;
      const mealDatetime = (dateStr && timeStr) ? `${dateStr}T${timeStr}` : "";
      lastMealDatetimeISO = mealDatetime;

      formData.append("height_cm", profile.height_cm || "");
      formData.append("weight_kg", profile.weight_kg || "");
      formData.append("meal_type", mealType || "");
      formData.append("meal_datetime", mealDatetime);

      fetch(API_URL + "/api/recommend", { method:"POST", body: formData, headers: NGROK_HEADERS })
        .then(res=>res.json())
        .then(data=>updateUIWithRecommend(data))
        .catch(err=>{
          console.log("override error:", err);
          showDemoCheckNotice("Override");
        });
    });

    // ===== History helpers =====
    function renderHistoryItem(item){
      const div = document.createElement("div");
      div.className = "card";
      const conf = typeof item.food_conf === "number" ? (item.food_conf*100).toFixed(1) : "0.0";
      div.innerHTML = `
        <div class="title">${escapeHtml(item.timestamp || "History")}</div>
        <div class="body"><b>${escapeHtml(item.food || "(unknown)")}</b> (${conf}%)</div>
        <div class="body" style="margin-top:8px; color:#334155;">${escapeHtml(item.summary || item.recommend || "")}</div>
      `;
      return div;
    }

    async function loadHistory(){
      historyContainer.innerHTML = "Loading history...";
      try{
        const res = await fetch(API_URL + "/api/history", { method:"GET", headers:{ ...NGROK_HEADERS }});
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.history || data.items || []);
        cachedHistory = Array.isArray(list) ? list : [];

        if(!cachedHistory.length){
          historyContainer.innerHTML = `<div class="card"><div class="title">HISTORY</div><div class="body">No history yet.</div></div>`;
          return;
        }

        historyContainer.innerHTML = "";
        cachedHistory.forEach(item => historyContainer.appendChild(renderHistoryItem(item)));
      }catch(err){
        console.log("history load error:", err);
        showDemoCheckNotice("History");
      }
    }

    function parseTimestamp(ts){ return new Date(ts); }
    function filterByDays(days){
      const now = new Date();
      const from = new Date(now.getTime() - days*24*60*60*1000);
      return cachedHistory.filter(item=>{
        if(!item.timestamp) return false;
        const t=parseTimestamp(item.timestamp);
        return t>=from && t<=now;
      });
    }
    function filterByDateRange(startStr,endStr){
      if(!startStr || !endStr) return [];
      const start=new Date(startStr);
      const end=new Date(endStr);
      end.setHours(23,59,59,999);
      return cachedHistory.filter(item=>{
        if(!item.timestamp) return false;
        const t=parseTimestamp(item.timestamp);
        return t>=start && t<=end;
      });
    }
    function summarizeMeals(list){
      if(!list || list.length===0) return "No data in this range.\n";
      let totalKcal=0,totalP=0,totalF=0,totalC=0,nutCount=0;
      list.forEach(item=>{
        if(item.nutrition && typeof item.nutrition.kcal==="number"){
          totalKcal += item.nutrition.kcal;
          totalP += item.nutrition.protein_g || 0;
          totalF += item.nutrition.fat_g || 0;
          totalC += item.nutrition.carbs_g || 0;
          nutCount++;
        }
      });
      let lines=[];
      lines.push(`Total meals in range: ${list.length}`);
      lines.push(`Meals with nutrition data: ${nutCount}`);
      if(nutCount>0){
        lines.push(`Average per meal: ${(totalKcal/nutCount).toFixed(0)} kcal, ${(totalP/nutCount).toFixed(1)} g protein, ${(totalF/nutCount).toFixed(1)} g fat, ${(totalC/nutCount).toFixed(1)} g carbs`);
      }
      return lines.join("\n");
    }

    function callAiHistoryAnalysis(mode){
      const payload = {
        mode,
        profile,
        start_date: startDateInput.value || null,
        end_date: endDateInput.value || null,
      };
      analysisAiResult.textContent = "Loading AI analysis based on your meal history...";

      fetch(API_URL + "/api/history_analyze", {
        method:"POST",
        headers:{ "Content-Type":"application/json", ...NGROK_HEADERS },
        body: JSON.stringify(payload),
      })
      .then(res=>res.json())
      .then(data=>{
        if(data.error){ analysisAiResult.textContent="Error: " + data.error; return; }
        const header = `Period: ${data.period || ""} (meals: ${data.count || 0})\n\n`;
        analysisAiResult.textContent = header + (data.text || "(no AI analysis)");
      })
      .catch(err=>{
        console.log("ai history analyze error:", err);
        showDemoCheckNotice("Insights");
      });
    }

    btnAnalyze7d.addEventListener("click", ()=>{
      const subset = filterByDays(7);
      analysisResult.textContent = summarizeMeals(subset);
      callAiHistoryAnalysis("7d");
    });
    btnAnalyze30d.addEventListener("click", ()=>{
      const subset = filterByDays(30);
      analysisResult.textContent = summarizeMeals(subset);
      callAiHistoryAnalysis("30d");
    });
    btnAnalyzeRange.addEventListener("click", ()=>{
      const subset = filterByDateRange(startDateInput.value, endDateInput.value);
      analysisResult.textContent = summarizeMeals(subset);
      callAiHistoryAnalysis("range");
    });

    btnHistoryRefresh.addEventListener("click", loadHistory);

    // ===== Nav button wiring =====
    document.getElementById("btn-go-photo-hero").addEventListener("click", ()=>showSection("photo"));
    document.getElementById("btn-go-simple").addEventListener("click", ()=>showSection("simple"));
    document.getElementById("btn-go-profile").addEventListener("click", ()=>showSection("profile"));

    document.getElementById("btn-simple-back").addEventListener("click", ()=>showSection("mode"));

    document.getElementById("btn-profile-next").addEventListener("click", ()=>{
      if(!profile.bmi){ alert("Please save your profile first."); return; }
      updateBmiInfo();
      showSection("profileMenu");
    });
    document.getElementById("btn-profile-back-home").addEventListener("click", ()=>showSection("mode"));

    document.getElementById("btn-go-photo").addEventListener("click", ()=>showSection("photo"));
    document.getElementById("btn-go-history").addEventListener("click", ()=>{
      showSection("history"); loadHistory();
    });

    document.getElementById("btn-profile-menu-back").addEventListener("click", ()=>showSection("profile"));
    document.getElementById("btn-profile-menu-home").addEventListener("click", ()=>showSection("mode"));

    document.getElementById("btn-photo-back").addEventListener("click", ()=>showSection("profileMenu"));
    document.getElementById("btn-photo-home").addEventListener("click", ()=>showSection("mode"));

    document.getElementById("btn-history-back").addEventListener("click", ()=>showSection("profileMenu"));
    document.getElementById("btn-history-home").addEventListener("click", ()=>showSection("mode"));

    document.getElementById("nav-today").addEventListener("click", ()=>showSection("photo"));
    document.getElementById("nav-history").addEventListener("click", ()=>{
      showSection("history"); loadHistory();
    });
    document.getElementById("nav-insights").addEventListener("click", ()=>{
      showSection("history");
      const subset = filterByDays(30);
      analysisResult.textContent = summarizeMeals(subset);
      callAiHistoryAnalysis("30d");
    });
  </script>
</body>
</html>
